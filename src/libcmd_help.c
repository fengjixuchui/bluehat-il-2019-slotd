#include <stdio.h>
#include <stdio.h>
#include <dirent.h>
#include <stdlib.h>
#include <string.h>

// print builtin commands
static void print_builtins(void)
{
    puts("builtin commands: ");
    puts("  exit");
    puts("  quit");
}

// if it starts with libcmd_ and ends with .so
static int is_ext(const struct dirent *d)
{
    size_t len;

    if (strncmp("libcmd_", d->d_name, sizeof("libcmd_") - 1) != 0) {
        return 0;
    }

    len = strlen(d->d_name);

    if (len < 3) {
        return 0;
    }

    return strcmp(&d->d_name[len - 3], ".so") == 0;
}

// print all extension files without libcmd_ and .so
static void print_exts(void)
{
    struct dirent **namelist = NULL;
    int i, n;

    puts("installed extensions: ");
 
    n = scandir(".", &namelist, is_ext, alphasort);
    if (n < 0) {
        perror("scandir");
        return;
    }

    for (i = 0; i < n; i++) {
        namelist[i]->d_name[strlen(namelist[i]->d_name) - 3] = '\0';
        printf("  %s\n", namelist[i]->d_name + 7);
        free(namelist[i]);
    }

    free(namelist);
}

static void print_banner(void)
{
    puts("actual debug shell no shits and giggles");
    puts("what do you need help for i thought you got this already");
}

static void print_egg(void)
{
	static const char egg[] = {
		0x20, 0x23, 0x23, 0x23, 0x23, 0x23, 0x20, 0x20, 0x20, 0x20, 0x20, 0x23,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x23, 0x0a, 0x23, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x23, 0x23, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x23, 0x23, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x23, 0x20, 0x20, 0x23, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20, 0x20, 0x23,
		0x20, 0x23, 0x0a, 0x20, 0x23, 0x23, 0x23, 0x23, 0x23, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x23, 0x0a,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20, 0x23,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x23, 0x0a, 0x23, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x23, 0x0a, 0x20, 0x23, 0x23, 0x23, 0x23, 0x23,
		0x20, 0x20, 0x20, 0x23, 0x23, 0x23, 0x23, 0x23, 0x20, 0x20, 0x20, 0x23,
		0x23, 0x23, 0x23, 0x23, 0x0a, 0x0a, 0x0a, 0x20, 0x23, 0x20, 0x20, 0x20,
		0x20, 0x23, 0x20, 0x20, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x20, 0x20,
		0x23, 0x20, 0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x23, 0x23, 0x23, 0x23,
		0x23, 0x23, 0x20, 0x20, 0x23, 0x23, 0x23, 0x23, 0x23, 0x0a, 0x20, 0x23,
		0x23, 0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x23,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20,
		0x23, 0x0a, 0x20, 0x23, 0x20, 0x23, 0x20, 0x20, 0x23, 0x20, 0x20, 0x23,
		0x23, 0x23, 0x23, 0x23, 0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20,
		0x23, 0x20, 0x20, 0x23, 0x23, 0x23, 0x23, 0x23, 0x20, 0x20, 0x20, 0x23,
		0x20, 0x20, 0x20, 0x20, 0x23, 0x0a, 0x20, 0x23, 0x20, 0x20, 0x23, 0x20,
		0x23, 0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x23,
		0x20, 0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x23, 0x23, 0x23, 0x23, 0x23, 0x0a, 0x20, 0x23, 0x20,
		0x20, 0x20, 0x23, 0x23, 0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x23, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x23, 0x0a,
		0x20, 0x23, 0x20, 0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x23, 0x23, 0x23,
		0x23, 0x23, 0x23, 0x20, 0x20, 0x20, 0x20, 0x23, 0x23, 0x20, 0x20, 0x20,
		0x20, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x20, 0x20, 0x23, 0x20, 0x20,
		0x20, 0x20, 0x23, 0x0a, 0x0a, 0x0a, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20,
		0x23, 0x20, 0x20, 0x20, 0x20, 0x23, 0x23, 0x20, 0x20, 0x20, 0x20, 0x23,
		0x23, 0x23, 0x23, 0x23, 0x20, 0x20, 0x20, 0x23, 0x23, 0x23, 0x23, 0x23,
		0x20, 0x20, 0x20, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x20, 0x20, 0x23,
		0x20, 0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x23, 0x23, 0x23, 0x23, 0x23,
		0x23, 0x20, 0x20, 0x23, 0x23, 0x23, 0x23, 0x23, 0x0a, 0x20, 0x23, 0x20,
		0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x23, 0x20,
		0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x23, 0x20,
		0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x23, 0x23, 0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x23, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20, 0x23,
		0x0a, 0x20, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x20, 0x20, 0x23, 0x20,
		0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20, 0x23,
		0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x23, 0x23,
		0x23, 0x23, 0x23, 0x20, 0x20, 0x20, 0x23, 0x20, 0x23, 0x20, 0x20, 0x23,
		0x20, 0x20, 0x23, 0x23, 0x23, 0x23, 0x23, 0x20, 0x20, 0x20, 0x23, 0x20,
		0x20, 0x20, 0x20, 0x23, 0x0a, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20, 0x23,
		0x20, 0x20, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x20, 0x20, 0x23, 0x23,
		0x23, 0x23, 0x23, 0x20, 0x20, 0x20, 0x23, 0x23, 0x23, 0x23, 0x23, 0x20,
		0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x23, 0x20,
		0x20, 0x23, 0x20, 0x23, 0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20, 0x23, 0x0a, 0x20, 0x23, 0x20,
		0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20, 0x23,
		0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x23, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x23, 0x23, 0x20, 0x20, 0x23, 0x20,
		0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20, 0x23,
		0x0a, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x23, 0x20,
		0x20, 0x20, 0x20, 0x23, 0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20, 0x20,
		0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x23, 0x23,
		0x23, 0x23, 0x23, 0x23, 0x20, 0x20, 0x23, 0x20, 0x20, 0x20, 0x20, 0x23,
		0x20, 0x20, 0x23, 0x23, 0x23, 0x23, 0x23, 0x23, 0x20, 0x20, 0x23, 0x23,
		0x23, 0x23, 0x23, 0x0a, 0x0a, 0x00
	};

    puts(egg);
}

static const struct command {
    const char *const cmd;
    int (*func)(void);
} commands[] = {
    {"d78d5b0ecc5b15cd751f63b29571dc2e", print_egg},
    {"banner", print_banner},
    {"builtins", print_builtins},
    {"exts", print_exts},
    {NULL, NULL},
};

void cmd_main(char *param)
{
    const struct command *cp;

    for (cp = commands; cp->func; cp++) {
    	// does not print the egg
        if ((param[0] == '\0' && cp != commands) || strcmp(param, cp->cmd) == 0) {
            cp->func();
            puts("");
        }
    }
}
